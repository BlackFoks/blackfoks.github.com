---
layout: post
title: "Не используйте #time_ago_in_words"
date: 2012-02-12 17:09
comments: true
categories:
---

В мире RoR для того, чтобы отобразить время в виде "5 minutes ago" принято использовать метод `time_ago_in_words`. Все бы ничего, однако расчет времени на стороне сервера достаточно ресурсоемок, поэтому для подобных расчетов вполне можно использовать  ресурсы клиента.

Для того, чтобы расчитать, сколько времени прошло между определенным моментом и текущим, рельсы предоставляют удобный helper-метод `time_ago_in_words`.

Что было
--------

Имеем следующий код:

{% codeblock lang:ruby %}
<%= times_ago_in_words(comment.created_at) %>
{% endcodeblock %}

В целом неплохо, но есть возможности для улучшения. Сейчас этот код вызывает следующие проблемы:

  1. Серверу приходится расчитывать время для каждого запроса - впустую расходуется мощность серверного процессора. Следует попробовать перенести расчет времени на сторону клиента.
  2. Если расчет прошедшего времени ведется сервером, то нам становится сложным закешировать страницу, так как, допустим, после того, как пользователь добавил комментарий, на странице показывается надпись "5 секунд назад". Если вы закешируется страницу, надпись все равно будет "5 секунд назад" даже если уже прошло 3 минуты (в зависимости от настроек кеширования).

Рефакторим
----------

Очевидно, что для решения этой проблемы надо использовать JavaScript. На стороне сервера нам надо будет отдавать время создания и обновления, вместо того чтобы расчитывать, сколько времени прошло. Затем, уже на стороне клиента, мы можем расчитать прошедшее время.

{% codeblock lang:html %}
<abbr class="timeago" title="<%= comment.created_at.getutc.iso8601 %>">
  <%= comment.created_at.to_s %>
</abbr>
{% endcodeblock %}


Следующее решение использует плагин для jQuery под названием [timeago](http://timeago.yarp.com/). Если хотите, можете использовать что-то другое.

{% codeblock lang:js %}
$("abbr.timeago").timeago();
{% endcodeblock %}

Теперь вашему серверу не придется рассчитывать прошедшее время, а кеширование страниц станет проще.

Это вольный перевод [вот этой best practice](http://rails-bestpractices.com/posts/105-not-use-time_ago_in_words).

Вот ссылка по локализации плагина: [https://gist.github.com/6251](https://gist.github.com/6251)

